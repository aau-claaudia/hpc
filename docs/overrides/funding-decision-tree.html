{% extends "main.html" %}

{% block header %}
<header class="md-header md-header--shadow" data-md-component="header"></header>
{% endblock %}

{% block tabs %}{% endblock %}

{% block container %}
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<link rel="stylesheet" href="../stylesheets/decision-tree.css">

<a class="go-to-home-btn" href="/"><span class="material-symbols-outlined" style="font-size: 20px; padding-right: 5px;">close</span>Close</a>
<div class="content">
  <div class="decision-header">
    <div>
      <div class="previous-btn">
        <span class="material-symbols-outlined" style="font-size: 20px;">chevron_left</span>Previous
      </div>
    </div>
    <div class="progress remaining-progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
      <div id="remaining-progress-bar" class="progress-bar" style="width: 0%"></div>
    </div>
  </div>

  <div class="decision-content">
    <div class="quiz-body">
      <div class="sections-container">
        <div class="survey md-typeset">
          <h4 id="quiz-title"></h4>
          <div id="quiz-title-hint"></div>
          <div id="subdescription"></div>
          <div class="question-content"></div>
          <div class="next-btn disabled">Next</div>
          <div class="button-container"></div>
        </div>
      </div>
    </div>

    <div class="finished">
      <div class="spec md-typeset">
        <div class="spec-content">
          <div class="spec-content-header">
            <div class="md-typeset">
              <h2 id="spec-title" style="text-align: left !important;"></h2>
            </div>
          </div>
          <div id="spec-description"></div>
          <button id="save-to-pdf-btn" class="btn btn-primary" style="font-family: Montserrat, 'sans-serif';font-size: 14px;font-weight: 500;margin-top: 0 !important;">Save to PDF</button>
        </div>
      </div>
    </div>
  </div>

  <div class="decision-tree-footer"></div>
</div>

<script>
  document.getElementById('save-to-pdf-btn').addEventListener('click', () => {
    window.print();
  });

  document.addEventListener('DOMContentLoaded', () => {
    // PRICES
    const prices = {
      storage: 250 / 12,
      backup: 500 / 12,
      cpu: 0.12,
      memory: 0.12 / 8,
      gpu: 6,
      dataStewardSalery: 600000
    };

    // QUIZ QUESTIONS
    // ------------------------------------------------------------
    // NOTE: We inserted a NEW question (index 3) after the backup question (index 2).
    // We then re-numbered subsequent questions. Make sure to keep the "next" references in sync.
    // ------------------------------------------------------------
    const quizData = [
      {
        // Q0
        question: "What is the expected duration of your project?",
        description: "Adjust the slider below to select the duration of your project.",
        subdescription: "0 month(s)",
        type: "slider", 
        min: 0, 
        max: 60, 
        unit: "month(s)", 
        step: "1",
        next: 1
      },
      {
        // Q1
        question: "What is the estimated data storage requirement?",
        description: "The price for storage data is estimated to 21 DKK/TB/month",
        subdescription: "Estimated costs: 0 DKK",
        type: "input", 
        min: 0, 
        max: 1000, 
        unit: "TB",
        next: 2
      },
      {
        // Q2
        question: "Do you need to store data in backup?",
        description: "The price for backup data is estimated to 42 DKK/TB/month",
        subdescription: "",
        type: "radio",
        options: ["Yes", "No"],
        next: 3
      },
      {
        // Q3 (NEW QUESTION) – after backup
        question: "Which kind of front-end computer do you need?",
        description: "A front-end computer handles user interaction tasks (such as data entry, job management, or graphical tools) before sending jobs to bigger compute nodes. If you’re unsure, the standard size is usually sufficient.",
        subdescription: "",
        type: "dropdown",
        // Our dropdown list with a “default” standard size as the first option
        options: [
          "Standard (2 CPU, 4 GB memory)", 
          "Medium (4 CPU, 8 GB memory)",
          "Large (8 CPU, 16 GB memory)"
        ],
        // Proceed to the next question
        next: 4
      },
      {
        // Q4 (old Q3)
        question: "Do you already know the specific compute type (e.g., GPU, CPU) and configuration you need?",
        description: "This will help us guide you better in selecting the compute resources.",
        subdescription: "",
        type: "radio",
        options: ["Yes", "No, I need assistance"],
        // If "Yes" => skip the next two questions (Q5 & Q6) => go to Q7
        // If "No" => go to Q5
        next: {
          "Yes": 7,
          "No, I need assistance": 5
        }
      },
      {
        // Q5 (old Q4)
        question: "What type of project are you working on?",
        description: "Select the option that best describes your project. This helps us suggest the appropriate compute type.",
        subdescription: "",
        type: "radio",
        options: [
          "Machine Learning/Deep Learning",
          "Data Analysis/ETL",
          "Scientific Simulations (e.g., physics, chemistry, biology)",
          "Image or Video Processing",
          "General Software Development",
          "Other"
        ],
        next: 6
      },
      {
        // Q6 (old Q5)
        question: "How large is your dataset?",
        description: "Provide an estimate of the total data size that you plan to process.",
        subdescription: "",
        type: "input", 
        min: 0, 
        max: 10000, 
        unit: "TB",
        next: 7
      },
      {
        // Q7 (old Q6)
        question: "Configure your compute requirements",
        description: "Adjust the sliders below to select your desired compute type.",
        subdescription: "Estimated total costs: 0 DKK/hour",
        type: "compute",
        next: 8
      },
      {
        // Q8 (old Q7)
        question: "Select the estimated amount of compute hours you need.",
        description: "",
        subdescription: "Estimated costs: 0 DKK",
        type: "input", 
        min: 0, 
        max: 100000, 
        unit: "hours",
        next: 9
      },
      {
        // Q9 (old Q8)
        question: "Do you require any software licenses?",
        description: "Please provide the estimated annual cost of the license(s).",
        subdescription: "Estimated costs: 0 DKK",
        type: "input", 
        min: 0, 
        max: 100000, 
        unit: "DKK",
        next: 10
      },
      {
        // Q10 (old Q9) - final
        question: "Do you require help from data stewards with tasks such as data management, organization, and compliance?",
        description: "Please specify the number of hours per week or single hours needed.",
        subdescription: "Estimated costs: 0 DKK",
        type: "dm", 
        min: 0, 
        max: 72, 
        unit: "hours/week", 
        step: 1,
        next: null  // triggers summary
      }
    ];

    // STATE & ELEMENTS
    const state = {
      currentQuestion: 0,
      answers: {},
      history: []
    };

    const elements = {
      title: document.getElementById('quiz-title'),
      hint: document.getElementById('quiz-title-hint'),
      subdesc: document.getElementById('subdescription'),
      content: document.querySelector('.question-content'),
      next: document.querySelector('.next-btn'),
      prev: document.querySelector('.previous-btn'),
      progress: document.getElementById('remaining-progress-bar'),
      finished: document.querySelector('.finished'),
      specTitle: document.getElementById('spec-title'),
      specDesc: document.getElementById('spec-description'),
      quizBody: document.querySelector('.quiz-body')
    };

    // HELPER FUNCTIONS
    function enableNext() {
      elements.next.classList.remove("disabled");
      elements.next.style.pointerEvents = "auto";
    }
    function disableNext() {
      elements.next.classList.add("disabled");
      elements.next.style.pointerEvents = "none";
    }
    function parseDate(value) {
      const years = Math.floor(value / 12);
      const months = value % 12;
      return `${years} year(s)${months > 0 ? ` and ${months} month(s)` : ""}`;
    }
    function updateProgress() {
      const currentStep = state.currentQuestion;
      const totalSteps = quizData.length;
      elements.progress.style.width = `${(currentStep / totalSteps) * 100}%`;
    }
    function convertCurrency(cost) {
      return Math.ceil(cost).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }) + ' DKK';
    }
    function calculateDMCost(hours, months, type) {
      const fullTimeHoursPerYear = 160.33 * 12;
      const hourlyRate = prices.dataStewardSalery / fullTimeHoursPerYear;
      const weeks = months * 4.35;
      const totalHours = (type === "weekly") ? hours * weeks : hours;
      return hourlyRate * totalHours;
    }

    // RENDER QUESTION
    function renderQuestion() {
      const question = quizData[state.currentQuestion];
      elements.title.textContent = question.question;
      elements.hint.textContent = question.description || "";
      elements.subdesc.textContent = question.subdescription || "";
      elements.content.innerHTML = "";
      disableNext();

      // Handle different question types
      if (question.type === "slider") {
        elements.content.innerHTML = `
          <input type="range" class="form-range" min="${question.min}" max="${question.max}" value="${question.min}" step="${question.step}">
        `;
        const slider = elements.content.querySelector("input");
        slider.addEventListener("input", () => {
          const value = parseInt(slider.value, 10);
          elements.subdesc.textContent = (question.unit === "month(s)" && value >= 12)
            ? parseDate(value)
            : `${value} ${question.unit}`;
          state.answers[state.currentQuestion] = value;
          enableNext();
        });
      }

      else if (question.type === "radio") {
        question.options.forEach((option, i) => {
          const radioHTML = `
            <div class="form-check question-option">
              <input class="form-check-input" type="radio" name="quizOptions" id="option${i}">
              <label class="form-check-label" for="option${i}">${option}</label>
            </div>
          `;
          elements.content.insertAdjacentHTML("beforeend", radioHTML);
        });

        // Special subdesc if backup question
        if (question.question === "Do you need to store data in backup?") {
          const months = state.answers[0] || 0;
          const storage = state.answers[1] || 0;
          elements.subdesc.textContent =
            `Estimated backup cost for the entire duration of your project: ${convertCurrency(storage * prices.backup * months)}`;
        }

        // Click handlers
        const formChecks = elements.content.querySelectorAll('.form-check');
        formChecks.forEach((formCheck, i) => {
          formCheck.addEventListener("click", () => {
            formCheck.querySelector(".form-check-input").checked = true;
            const selectedText = question.options[i];
            // Store as boolean if 'Yes'/'No', otherwise store text
            if (selectedText.toLowerCase().startsWith("yes")) {
              state.answers[state.currentQuestion] = true;
            } else if (selectedText.toLowerCase().startsWith("no")) {
              state.answers[state.currentQuestion] = false;
            } else {
              state.answers[state.currentQuestion] = selectedText;
            }
            enableNext();
          });
        });
      }

      else if (question.type === "input") {
        elements.content.innerHTML = `
          <div class="input-group">
            <input type="number" class="form-control" min="${question.min}" placeholder="0">
            <span>${question.unit}</span>
          </div>
        `;
        const numberInput = elements.content.querySelector("input");
        numberInput.addEventListener("input", () => {
          const value = parseFloat(numberInput.value);
          if (value >= question.min) {
            state.answers[state.currentQuestion] = value;
            const months = state.answers[0] || 0;
            const computeCostObj = state.answers[8] || { cost: 0 };

            if (question.unit === "hours") {
              // This is the "compute hours" question
              elements.subdesc.textContent =
                `Estimated costs: ${convertCurrency(value * computeCostObj.cost)}`;
              state.answers[state.currentQuestion] = {
                cost: value * computeCostObj.cost,
                hours: value
              };
            } else if (question.unit === "TB") {
              // This is for data storage size
              elements.subdesc.textContent =
                `Estimated costs: ${convertCurrency(value * prices.storage * months)}`;
            } else if (question.unit === "DKK") {
              // License cost (annual) => scale to project length
              elements.subdesc.textContent =
                `Estimated costs: ${convertCurrency((value / 12) * months)}`;
              state.answers[state.currentQuestion] = (value / 12) * months;
            }
            enableNext();
          } else {
            disableNext();
            elements.subdesc.textContent = `Estimated costs: 0 DKK`;
          }
        });
      }

      // NEW TYPE: DROPDOWN
      else if (question.type === "dropdown") {

        const months = state.answers[0] || 0;

        let selectHTML = '<select class="form-select">';
        question.options.forEach((option) => {
          selectHTML += `<option value="${option}">${option}</option>`;
        });
        selectHTML += '</select>';
        elements.content.innerHTML = selectHTML;

        const selectEl = elements.content.querySelector('select');
        // Default to the first option
        const cpuPrice = prices.cpu * 2 * 24 * 30 * months;  // 2 cpus * 24 hours * 30 days * project duration in months
        const memPrice = prices.memory * 4 * 24 * 30 * months;  // 4GB memory * 24 hours * 30 days * project duration in months
        elements.subdesc.textContent = `Estimated costs: ${convertCurrency(cpuPrice + memPrice)}`;
        selectEl.value = question.options[0];
        state.answers[state.currentQuestion] = question.options[0];
        enableNext();

        

        selectEl.addEventListener('change', () => {
            if (question.question === "Which kind of front-end computer do you need?") {
                if (selectEl.value == "Standard (2 CPU, 4 GB memory)") {
                    const cpuPrice = prices.cpu * 2 * 24 * 30 * months;  // 2 cpus * 24 hours * 30 days * project duration in months
                    const memPrice = prices.memory * 4 * 24 * 30 * months;  // 4GB memory * 24 hours * 30 days * project duration in months
                    elements.subdesc.textContent = `Estimated costs: ${convertCurrency(cpuPrice + memPrice)}`;
                    state.answers[state.currentQuestion] = convertCurrency(cpuPrice + memPrice);    
                } else if (selectEl.value == "Medium (4 CPU, 8 GB memory)") {
                    const cpuPrice = prices.cpu * 4 * 24 * 30 * months;  // 4 cpus * 24 hours * 30 days * project duration in months
                    const memPrice = prices.memory * 8 * 24 * 30 * months;  // 8GB memory * 24 hours * 30 days * project duration in months
                    elements.subdesc.textContent = `Estimated costs: ${convertCurrency(cpuPrice + memPrice)}`;
                    state.answers[state.currentQuestion] = convertCurrency(cpuPrice + memPrice);    
                } else if (selectEl.value == "Large (8 CPU, 16 GB memory)") {
                    const cpuPrice = prices.cpu * 8 * 24 * 30 * months;  // 8 cpus * 24 hours * 30 days * project duration in months
                    const memPrice = prices.memory * 16 * 24 * 30 * months;  // 16GB memory * 24 hours * 30 days * project duration in months
                    elements.subdesc.textContent = `Estimated costs: ${convertCurrency(cpuPrice + memPrice)}`;
                    state.answers[state.currentQuestion] = convertCurrency(cpuPrice + memPrice);    
                }
            } else {
                state.answers[state.currentQuestion] = selectEl.value;
            }

          enableNext();
        });
      }

      else if (question.type === "compute") {
        elements.content.innerHTML = `
          <div style="display: flex; flex-direction: column;">
            <div class="form-group">
              <label class="form-label">CPUs:</label>
              <div style="display: flex;">
                <input type="range" class="form-range" id="cpu-slider" min="0" max="192" step="1" value="0">
                <span class="me-1" id="cpu-value">0</span>CPU(s)
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Memory:</label>
              <div style="display: flex;">
                <input type="range" class="form-range" id="memory-slider" min="0" max="2048" step="1" value="0">
                <span class="me-1" id="memory-value">0</span>GB
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">GPUs:</label>
              <div style="display: flex;">
                <input type="range" class="form-range" id="gpu-slider" min="0" max="8" step="1" value="0">
                <span class="me-1" id="gpu-value">0</span>GPU(s)
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Quantity:</label>
              <div style="display: flex;">
                <input type="range" class="form-range" id="quantity-slider" min="1" max="20" step="1" value="1">
                <span class="me-1" id="quantity-value">1</span>machine(s)
              </div>
            </div>
          </div> 
        `;
        const cpuSlider = document.getElementById("cpu-slider");
        const memorySlider = document.getElementById("memory-slider");
        const gpuSlider = document.getElementById("gpu-slider");
        const quantitySlider = document.getElementById("quantity-slider");

        function updateComputeCost() {
          const cpuCount = +cpuSlider.value;
          const memorySize = +memorySlider.value;
          const gpuCount = +gpuSlider.value;
          const machineCount = +quantitySlider.value;

          const cpuCost = cpuCount * prices.cpu;
          // 1 CPU includes 8 GB memory for free
          const includedMemory = cpuCount * 8;
          const extraMemory = Math.max(memorySize - includedMemory, 0);
          const memoryCost = extraMemory * prices.memory;
          const gpuCost = gpuCount * prices.gpu;
          const computeCost = (cpuCost + memoryCost + gpuCost) * machineCount;

          elements.subdesc.textContent =
            `Estimated total costs: ${computeCost.toFixed(2)} DKK/hour`;
          state.answers[state.currentQuestion] = {
            cost: computeCost,
            type: `${machineCount} machine(s) with ${cpuCount} CPU(s), ${memorySize} GB memory, ${gpuCount} GPU(s)`
          };

          if (gpuCount > 0 || cpuCount > 0 || memorySize > 0) {
            enableNext();
          } else {
            disableNext();
          }
        }
        [cpuSlider, memorySlider, gpuSlider, quantitySlider].forEach(slider => {
          slider.addEventListener("input", () => {
            document.getElementById(slider.id.replace("-slider", "-value")).textContent = slider.value;
            updateComputeCost();
          });
        });
      }

      else if (question.type === "dm") {
        elements.content.innerHTML = `
          <div style="display: flex; flex-direction: column;">
            <div class="form-group">
              <label class="form-label">For weekly assistance:</label>
              <div style="display: flex;">
                <input type="range" class="form-range" id="hour-slider" min="0" max="72" step="1" value="0">
                <span class="me-1" id="hour-value">0</span>hours/week
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">For single time assistance:</label>
              <div class="input-group" style="justify-content: left !important;">
                <input type="number" class="form-control" id="single-input" min="0" placeholder="0">
                <span>hours</span>
              </div>
            </div>
          </div>
        `;
        const hourSlider = document.getElementById("hour-slider");
        const singleInput = document.getElementById("single-input");

        hourSlider.addEventListener("input", () => {
          document.getElementById("hour-value").textContent = hourSlider.value;
          singleInput.value = null;
          const months = state.answers[0] || 0;
          const totalDMCost = calculateDMCost(hourSlider.value, months, "weekly");
          elements.subdesc.textContent =
            `Estimated total costs: ${convertCurrency(totalDMCost)}`;

          state.answers.dataStewardWeeklyHours = hourSlider.value;
          state.answers.dataStewardSingleHours = 0;
          state.answers.dataStewardCost = totalDMCost;
          (hourSlider.value > 0) ? enableNext() : disableNext();
        });

        singleInput.addEventListener("input", () => {
          hourSlider.value = 0;
          document.getElementById("hour-value").textContent = 0;
          const value = +singleInput.value;
          const months = state.answers[0] || 0;
          const totalDMCost = calculateDMCost(value, months, "single");
          elements.subdesc.textContent =
            `Estimated total costs: ${convertCurrency(totalDMCost)}`;

          state.answers.dataStewardWeeklyHours = 0;
          state.answers.dataStewardSingleHours = value;
          state.answers.dataStewardCost = totalDMCost;
          (value > 0) ? enableNext() : disableNext();
        });
      }

      elements.next.textContent =
        (question.next === null) ? "Calculate costs" : "Next";

      updateProgress();
    }

    // CALCULATE TOTAL COST
    function calculateTotalCost() {
      const months = state.answers[0] || 0;
      const storageAmount = state.answers[1] || 0;
      const needsBackup = state.answers[2] || false;
      // front-end selection is state.answers[3], but not currently used in cost calculations
      const computeDetails = state.answers[7] || { cost: 0, type: "N/A" };
      const computeHourDetails = state.answers[8] || { cost: 0, hours: 0 };
      const licenseCosts = state.answers[9] || 0;
      const dataStewardCost = state.answers.dataStewardCost || 0;

      const totalStorageCost = storageAmount * prices.storage * months;
      const totalBackupCost = needsBackup ? storageAmount * prices.backup * months : 0;
      const totalComputeCost = computeHourDetails.cost || 0;
      const totalCost = totalStorageCost + totalBackupCost + totalComputeCost + licenseCosts + dataStewardCost;

      return {
        total: convertCurrency(totalCost),
        storage: convertCurrency(totalStorageCost + totalBackupCost),
        compute: convertCurrency(totalComputeCost),
        licenses: convertCurrency(licenseCosts),
        stewards: convertCurrency(dataStewardCost),
        details: {
          projectDuration: parseDate(months),
          storageAmount: `${storageAmount} TB`,
          needsBackup: needsBackup ? "Yes" : "No",
          frontEndChoice: state.answers[3] || "N/A",
          computeHours: computeHourDetails.hours || 0,
          machineType: computeDetails.type || "N/A",
          licenseCost: (licenseCosts > 0) ? `${licenseCosts} DKK/year` : "None"
        }
      };
    }

    // GO TO NEXT QUESTION
    function goNext() {
      const question = quizData[state.currentQuestion];

      if (question.next === null) {
        showResults();
        return;
      }
      // Keep history for "Previous"
      state.history.push(state.currentQuestion);

      if (typeof question.next === "number") {
        state.currentQuestion = question.next;
      } else if (typeof question.next === "object") {
        const userAnswer = quizData[state.currentQuestion].options.find(opt => {
          if (typeof state.answers[state.currentQuestion] === 'boolean') {
            // Yes/No logic
            if (state.answers[state.currentQuestion] && opt.toLowerCase().startsWith("yes")) return true;
            if (!state.answers[state.currentQuestion] && opt.toLowerCase().startsWith("no")) return true;
          } else {
            return opt === state.answers[state.currentQuestion];
          }
          return false;
        });
        state.currentQuestion = question.next[userAnswer];
      }
      renderQuestion();
    }

    // SHOW RESULTS
    function showResults() {
      const { total, storage, compute, licenses, stewards, details } = calculateTotalCost();
      elements.title.textContent = "Quiz complete!";
      elements.hint.textContent = "";
      elements.content.innerHTML = "";
      elements.finished.style.display = "block";
      elements.quizBody.style.display = "none";

      elements.specTitle.textContent = "Your cost breakdown:";
      elements.specDesc.innerHTML = `
        <div class="result-group">
          <div class="result-header">
            <p class="result-title">Total cost:</p>
            <span class="badge bg-primary">${total}</span>
          </div>
          <p class="result-subtitle">Project duration: ${details.projectDuration}</p>
        </div>
        <div class="result-group">
          <div class="result-header">
            <p class="result-title">Storage cost:</p>
            <span class="badge bg-secondary">${storage}</span>
          </div>
          <p class="result-subtitle">Storage amount: ${details.storageAmount}</p>
          <p class="result-subtitle">Backup: ${details.needsBackup}</p>
        </div>
        <div class="result-group">
          <div class="result-header">
            <p class="result-title">Compute cost:</p>
            <span class="badge bg-secondary">${compute}</span>
          </div>
          <p class="result-subtitle">Type: ${details.machineType}</p>
          <p class="result-subtitle">Hours: ${details.computeHours} hours</p>
        </div>
        <div class="result-group">
          <div class="result-header">
            <p class="result-title">License cost:</p>
            <span class="badge bg-secondary">${licenses}</span>
          </div>
        </div>
        <div class="result-group">
          <div class="result-header">
            <p class="result-title">Data steward cost:</p>
            <span class="badge bg-secondary">${stewards}</span>
          </div>
          <p class="result-subtitle">Weekly assistance: ${state.answers.dataStewardWeeklyHours || 0} hours</p>
          <p class="result-subtitle">Single assistance: ${state.answers.dataStewardSingleHours || 0} hours</p>
        </div>
        <hr/>
        <div class="result-group">
          <p class="result-subtitle"><strong>Front-end computer choice:</strong> ${details.frontEndChoice}</p>
        </div>
      `;

      elements.progress.style.width = "100%";
      // Turn "Previous" into "Reset"
      elements.prev.childNodes[1].nodeValue = "Reset";
    }

    // GO TO PREVIOUS QUESTION
    function goPrevious() {
      // If on results page (button says Reset), do a full reset:
      if (elements.prev.textContent.includes('Reset')) {
        state.currentQuestion = 0;
        state.answers = {};
        state.history = [];
        elements.quizBody.style.display = 'block';
        elements.finished.style.display = 'none';
        elements.prev.childNodes[1].nodeValue = "Previous";
        renderQuestion();
        return;
      }
      // Otherwise, go back in history if possible
      if (state.history.length) {
        state.currentQuestion = state.history.pop();
        renderQuestion();
      }
    }

    elements.next.addEventListener("click", () => {
      if (!elements.next.classList.contains("disabled")) {
        goNext();
      }
    });
    elements.prev.addEventListener("click", goPrevious);

    // INITIAL RENDER
    renderQuestion();
  });
</script>
{% endblock %}
